# 📄 **배포 가이드 (Deployment Guide)**

> **프로젝트명**: Memory Forest - AI 기반 치매 케어 인지 훈련 플랫폼
> 
> **작성일**: 2025.01.15
> 
> **작성자**: DevOps 엔지니어

---

## 🚀 1. 배포 개요

### **1.1 배포 환경**
- **개발 환경**: 로컬 개발 환경
- **테스트 환경**: Docker Compose 기반 통합 테스트
- **스테이징 환경**: 운영 환경과 유사한 구성
- **운영 환경**: 프로덕션 서버 배포

### **1.2 배포 방식**
- **컨테이너 기반**: Docker + Docker Compose
- **자동화**: GitHub Actions CI/CD
- **오케스트레이션**: Docker Compose v2
- **모니터링**: 로그 수집 및 상태 모니터링

---

## 🛠️ 2. 사전 준비사항

### **2.1 시스템 요구사항**

#### **최소 시스템 사양**
- **CPU**: 4코어 이상
- **메모리**: 8GB 이상
- **저장공간**: 50GB 이상 (SSD 권장)
- **네트워크**: 100Mbps 이상

#### **운영체제**
- **Linux**: Ubuntu 20.04 LTS 이상
- **Windows**: Windows 10/11 (개발 환경)
- **macOS**: macOS 12.0 이상 (개발 환경)

### **2.2 필수 소프트웨어**

#### **Docker 환경**
```bash
# Docker 설치 확인
docker --version
docker-compose --version

# 권장 버전
Docker version 24.x.x
Docker Compose version 2.x.x
```

#### **Git 환경**
```bash
# Git 설치 확인
git --version

# 권장 버전
git version 2.30.0 이상
```

### **2.3 환경 변수 설정**

#### **환경 변수 파일 생성**
```bash
# .env 파일 생성
cp .env.example .env

# 환경 변수 편집
nano .env
```

#### **필수 환경 변수**
```bash
# 데이터베이스 설정
DB_HOST=localhost
DB_PORT=3306
DB_NAME=memory_forest
DB_USER=kcc
DB_PASSWORD=kcc

# Redis 설정
REDIS_HOST=localhost
REDIS_PORT=6379

# AI 서비스 설정
AI_SERVICE_URL=http://localhost:8000

# OAuth2 설정
NAVER_CLIENT_ID=your_naver_client_id
NAVER_CLIENT_SECRET=your_naver_client_secret

# 이메일 설정
GMAIL_USERNAME=your_gmail_username
GMAIL_PASSWORD=your_gmail_app_password

# AWS S3 설정
AWS_ACCESS_KEY_ID=your_aws_access_key
AWS_SECRET_ACCESS_KEY=your_aws_secret_key
AWS_REGION=ap-northeast-2
AWS_S3_BUCKET=your_s3_bucket_name
```

---

## 🐳 3. Docker 환경 구축

### **3.1 Docker 설치**

#### **Ubuntu/Debian**
```bash
# 패키지 업데이트
sudo apt update

# Docker 설치
sudo apt install docker.io docker-compose

# Docker 서비스 시작
sudo systemctl start docker
sudo systemctl enable docker

# 사용자 그룹에 추가
sudo usermod -aG docker $USER

# 재로그인 후 확인
docker --version
```

#### **Windows**
```bash
# Docker Desktop 다운로드 및 설치
# https://www.docker.com/products/docker-desktop

# 설치 후 Docker Desktop 실행
# WSL 2 백엔드 권장
```

#### **macOS**
```bash
# Homebrew를 통한 설치
brew install --cask docker

# 또는 Docker Desktop 다운로드
# https://www.docker.com/products/docker-desktop
```

### **3.2 Docker Compose 설치**

#### **최신 버전 설치**
```bash
# Docker Compose v2 설치
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# 실행 권한 부여
sudo chmod +x /usr/local/bin/docker-compose

# 버전 확인
docker-compose --version
```

---

## 🗄️ 4. 데이터베이스 설정

### **4.1 MySQL 데이터베이스**

#### **데이터베이스 생성**
```sql
-- MySQL 접속
mysql -u root -p

-- 데이터베이스 생성
CREATE DATABASE memory_forest CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 사용자 생성 및 권한 부여
CREATE USER 'kcc'@'%' IDENTIFIED BY 'kcc';
GRANT ALL PRIVILEGES ON memory_forest.* TO 'kcc'@'%';
FLUSH PRIVILEGES;

-- 데이터베이스 확인
SHOW DATABASES;
USE memory_forest;
```

#### **초기 스키마 적용**
```bash
# 프로젝트 루트 디렉토리에서
cd docker/mysql

# 초기 스키마 적용
mysql -u kcc -p memory_forest < init.sql
```

### **4.2 Redis 설정**

#### **Redis 설정 파일**
```bash
# Redis 설정 파일 생성
mkdir -p /etc/redis
nano /etc/redis/redis.conf
```

#### **Redis 설정 내용**
```conf
# 기본 설정
bind 0.0.0.0
port 6379
timeout 300
tcp-keepalive 60

# 메모리 설정
maxmemory 256mb
maxmemory-policy allkeys-lru

# 지속성 설정
save 900 1
save 300 10
save 60 10000

# 로그 설정
loglevel notice
logfile /var/log/redis/redis.log
```

---

## 🚀 5. 애플리케이션 배포

### **5.1 전체 서비스 배포**

#### **Docker Compose 실행**
```bash
# 프로젝트 루트 디렉토리에서
cd docker

# 서비스 빌드 및 실행
docker-compose up -d --build

# 서비스 상태 확인
docker-compose ps

# 로그 확인
docker-compose logs -f
```

#### **개별 서비스 배포**
```bash
# 특정 서비스만 빌드
docker-compose build ai-service

# 특정 서비스만 실행
docker-compose up -d ai-service

# 특정 서비스 로그 확인
docker-compose logs -f ai-service
```

### **5.2 서비스별 배포 순서**

#### **1단계: 인프라 서비스**
```bash
# 데이터베이스 및 Redis 먼저 실행
docker-compose up -d mysql-db redis

# 상태 확인
docker-compose ps mysql-db redis
```

#### **2단계: AI 서비스**
```bash
# AI 서비스 실행
docker-compose up -d ai-service

# AI 서비스 상태 확인
curl http://localhost:8000/health
```

#### **3단계: 백엔드 서비스**
```bash
# Spring Boot 백엔드 실행
docker-compose up -d backend

# 백엔드 상태 확인
curl http://localhost:8080/actuator/health
```

#### **4단계: 프론트엔드 서비스**
```bash
# React 프론트엔드 실행
docker-compose up -d frontend

# 프론트엔드 상태 확인
curl http://localhost:3000
```

#### **5단계: 프록시 서비스**
```bash
# Nginx 프록시 실행
docker-compose up -d nginx

# 전체 서비스 상태 확인
docker-compose ps
```

---

## 🔧 6. 환경별 배포

### **6.1 개발 환경**

#### **로컬 개발 환경**
```bash
# 개발용 Docker Compose 실행
docker-compose -f docker-compose.dev.yml up -d

# 또는 개발 모드로 실행
cd frontend
npm run dev

cd ../backend/SpringBoot
./gradlew bootRun

cd ../ai
python main.py
```

#### **개발 환경 설정**
```bash
# 개발용 환경 변수
NODE_ENV=development
SPRING_PROFILES_ACTIVE=dev
PYTHON_ENV=development
```

### **6.2 테스트 환경**

#### **테스트 환경 배포**
```bash
# 테스트용 Docker Compose 실행
docker-compose -f docker-compose.test.yml up -d

# 테스트 실행
cd backend/SpringBoot
./gradlew test

cd ../ai
python -m pytest tests/
```

### **6.3 운영 환경**

#### **운영 환경 배포**
```bash
# 운영용 Docker Compose 실행
docker-compose -f docker-compose.prod.yml up -d

# 운영 환경 설정
NODE_ENV=production
SPRING_PROFILES_ACTIVE=prod
PYTHON_ENV=production
```

---

## 📊 7. 모니터링 및 로그

### **7.1 서비스 상태 모니터링**

#### **Docker 서비스 상태**
```bash
# 전체 서비스 상태
docker-compose ps

# 특정 서비스 상태
docker-compose ps backend

# 서비스 리소스 사용량
docker stats
```

#### **애플리케이션 상태 확인**
```bash
# 백엔드 상태
curl http://localhost:8080/actuator/health

# AI 서비스 상태
curl http://localhost:8000/health

# 프론트엔드 상태
curl http://localhost:3000
```

### **7.2 로그 수집 및 분석**

#### **로그 확인**
```bash
# 전체 로그
docker-compose logs

# 특정 서비스 로그
docker-compose logs backend

# 실시간 로그
docker-compose logs -f

# 로그 필터링
docker-compose logs backend | grep ERROR
```

#### **로그 파일 위치**
```bash
# Docker 로그
/var/lib/docker/containers/

# 애플리케이션 로그
./logs/
./backend/SpringBoot/logs/
./ai/logs/
```

---

## 🔒 8. 보안 설정

### **8.1 방화벽 설정**

#### **Ubuntu/Debian**
```bash
# UFW 방화벽 활성화
sudo ufw enable

# 필요한 포트만 허용
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 3306/tcp  # MySQL (내부 네트워크만)
sudo ufw allow 6379/tcp  # Redis (내부 네트워크만)

# 방화벽 상태 확인
sudo ufw status
```

#### **CentOS/RHEL**
```bash
# firewalld 활성화
sudo systemctl enable firewalld
sudo systemctl start firewalld

# 필요한 포트 허용
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload

# 방화벽 상태 확인
sudo firewall-cmd --list-all
```

### **8.2 SSL/TLS 설정**

#### **Let's Encrypt 인증서 발급**
```bash
# Certbot 설치
sudo apt install certbot

# 인증서 발급
sudo certbot certonly --standalone -d your-domain.com

# 인증서 자동 갱신
sudo crontab -e
# 0 12 * * * /usr/bin/certbot renew --quiet
```

#### **Nginx SSL 설정**
```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;
    
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers off;
    
    # 기타 설정...
}
```

---

## 🔄 9. CI/CD 파이프라인

### **9.1 GitHub Actions 설정**

#### **CI/CD 워크플로우 파일**
```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Docker
      uses: docker/setup-buildx-action@v2
    
    - name: Build and push Docker images
      run: |
        docker build -t memory-forest-backend ./backend
        docker build -t memory-forest-frontend ./frontend
        docker build -t memory-forest-ai ./ai
    
    - name: Deploy to server
      run: |
        # 서버에 배포 스크립트 실행
        ssh user@server 'cd /opt/memory-forest && docker-compose pull && docker-compose up -d'
```

### **9.2 자동 배포 스크립트**

#### **배포 스크립트**
```bash
#!/bin/bash
# deploy.sh

echo "🚀 Memory Forest 배포 시작..."

# 최신 코드 가져오기
git pull origin main

# 환경 변수 확인
if [ ! -f .env ]; then
    echo "❌ .env 파일이 없습니다."
    exit 1
fi

# Docker 이미지 빌드
echo "📦 Docker 이미지 빌드 중..."
docker-compose build

# 기존 서비스 중지
echo "⏹️ 기존 서비스 중지 중..."
docker-compose down

# 새 서비스 시작
echo "▶️ 새 서비스 시작 중..."
docker-compose up -d

# 상태 확인
echo "🔍 서비스 상태 확인 중..."
sleep 10
docker-compose ps

echo "✅ 배포 완료!"
```

---

## 🚨 10. 문제 해결

### **10.1 일반적인 문제**

#### **포트 충돌**
```bash
# 포트 사용 확인
sudo netstat -tulpn | grep :8080

# 프로세스 종료
sudo kill -9 <PID>

# 또는 다른 포트 사용
# docker-compose.yml에서 포트 변경
```

#### **메모리 부족**
```bash
# 메모리 사용량 확인
free -h

# Docker 리소스 제한
# docker-compose.yml에서 메모리 제한 설정
services:
  backend:
    deploy:
      resources:
        limits:
          memory: 2G
```

#### **디스크 공간 부족**
```bash
# 디스크 사용량 확인
df -h

# Docker 정리
docker system prune -a

# 로그 파일 정리
sudo journalctl --vacuum-time=7d
```

### **10.2 서비스별 문제**

#### **백엔드 서비스 문제**
```bash
# 로그 확인
docker-compose logs backend

# JVM 힙 메모리 확인
docker exec -it spring-backend jstat -gc <PID>

# 데이터베이스 연결 확인
docker exec -it spring-backend mysql -h mysql-db -u kcc -p
```

#### **AI 서비스 문제**
```bash
# 모델 로딩 확인
docker exec -it ai-service python -c "import gensim; print('Model loaded')"

# 메모리 사용량 확인
docker exec -it ai-service free -h

# Python 패키지 확인
docker exec -it ai-service pip list
```

#### **프론트엔드 서비스 문제**
```bash
# 빌드 로그 확인
docker-compose logs frontend

# Node.js 버전 확인
docker exec -it react-frontend node --version

# 패키지 의존성 확인
docker exec -it react-frontend npm list
```

---

## 📈 11. 성능 최적화

### **11.1 Docker 최적화**

#### **멀티 스테이지 빌드**
```dockerfile
# Backend Dockerfile 최적화
FROM eclipse-temurin:21-jdk-alpine as builder
WORKDIR /app
COPY . .
RUN ./gradlew build -x test

FROM eclipse-temurin:21-jre-alpine
WORKDIR /app
COPY --from=builder /app/build/libs/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

#### **리소스 제한**
```yaml
# docker-compose.yml
services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
```

### **11.2 애플리케이션 최적화**

#### **JVM 튜닝**
```bash
# JVM 옵션 설정
JAVA_OPTS="-Xms512m -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
```

#### **데이터베이스 최적화**
```sql
-- MySQL 설정 최적화
SET GLOBAL innodb_buffer_pool_size = 1073741824; -- 1GB
SET GLOBAL innodb_log_file_size = 268435456; -- 256MB
SET GLOBAL max_connections = 200;
```

---

## 📋 12. 배포 체크리스트

### **12.1 사전 배포 체크**

- [ ] 환경 변수 설정 완료
- [ ] 데이터베이스 스키마 적용
- [ ] Docker 이미지 빌드 테스트
- [ ] 네트워크 연결 확인
- [ ] 방화벽 설정 확인

### **12.2 배포 중 체크**

- [ ] 인프라 서비스 실행 확인
- [ ] AI 서비스 실행 확인
- [ ] 백엔드 서비스 실행 확인
- [ ] 프론트엔드 서비스 실행 확인
- [ ] 프록시 서비스 실행 확인

### **12.3 배포 후 체크**

- [ ] 서비스 상태 확인
- [ ] API 엔드포인트 테스트
- [ ] 데이터베이스 연결 테스트
- [ ] 로그 확인
- [ ] 모니터링 설정 확인

---

## 📞 13. 지원 및 연락처

### **13.1 기술 지원**
- **DevOps 팀**: devops@memoryforest.com
- **백엔드 팀**: backend@memoryforest.com
- **프론트엔드 팀**: frontend@memoryforest.com
- **AI 팀**: ai@memoryforest.com

### **13.2 문서 및 리소스**
- **프로젝트 문서**: [GitHub Wiki](https://github.com/memory-forest/docs)
- **API 문서**: [Swagger UI](http://localhost:8080/swagger-ui.html)
- **모니터링**: [Grafana Dashboard](http://localhost:3000)

---

**문서 정보**
- 작성일: 2025년 1월 15일
- 버전: v1.0
- 작성자: DevOps 엔지니어
- 검토자: 시스템 아키텍트
- 승인자: 기술 책임자
